name: Jekyll site CI

on:
  push:
    branches: [ master ]

  pull_request:
    branches: [ master ]
    types: [opened, synchronize, closed]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:

    - name: Enable GitHub debug logging
      run: |
        echo "ACTIONS_STEP_DEBUG=true" >> $GITHUB_ENV
        echo "GIT_TRACE=1" >> $GITHUB_ENV
        echo "GIT_CURL_VERBOSE=1" >> $GITHUB_ENV

    - name: Enable git debugging
      run: |
        git config --global advice.detachedHead false
        git config --global log.showSignature false
        git config --global fetch.showForcedUpdates true
        git config --global core.verbose true
        git config --global submodule.recurse true
        git config --global transfer.fsckobjects true
        git config --global trace true || true

    - name: Checkout repo with submodules (including PAT for submodule(s) with private repo)
      # uses: actions/checkout@v6
      #     This industry is shit
      # uses: actions/checkout@v4
      # uses: actions/checkout@v6
      # uses: actions/checkout@v5
      uses: actions/checkout@v6
      with:
         repository: "${{ github.repository }}"
         token: ${{ secrets.GH_PAT_FOR_SUBMODULES_PULL }}
         submodules: "recursive"
         persist-credentials: false
    
    - name: Force PAT for submodules
      run: |
        git config --global url."https://${{ secrets.GH_PAT_FOR_SUBMODULES_PULL }}:@github.com/".insteadOf "https://github.com/"

    - name: "Debug contents: List workspace content (pre-sm)"
      run: |
        echo "1=== check Submodules ==="
        git submodule status
        echo "2==="
        ls -R demos
        echo "3==="
        git submodule update --init --recursive
        echo "4==="
        ls -la
        echo "5==="
        ls -R demos
        echo "6==="
        ls -la ${{ github.workspace }}
    
    # Can be removed: manual git submodule updateâ€”unnecessary when using checkout correctly.
    #- name: Checkout submodules (why not odone automatically? how was it working before, then?)
    #  run: git submodule update --init --recursive
    #
    #- name: List workspace content (post-sm)
    #  run: ls -la ${{ github.workspace }}
#
# From: https://github.com/marketplace/actions/checkout-submodules
#    - name: Checkout submodules
#      uses: srt32/git-actions@v0.0.3
#      with:
#        args: git submodule update --init --recursive

    - name: Build the site in the jekyll/builder container
      run: |
        docker run \
          -v ${{ github.workspace }}:/srv/jekyll \
          -v ${{ github.workspace }}/_site:/srv/jekyll/_site \
          jekyll/builder:latest \
              /bin/bash -c "
                  chmod 777 /srv/jekyll &&
                  jekyll build --trace --future --disable-disk-cache --verbose
              "

