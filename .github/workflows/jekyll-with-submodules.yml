
# Note: Apart foemr this, there exists a
#      "GitHub Pages auto-deployment workflow"

name: Jekyll site CI by sosi himself

on:
  push:
    branches: [ master ]

  pull_request:
    branches: [ master ]
    types: [opened, synchronize, closed]

jobs:
  buildMaPage:

    runs-on: ubuntu-latest

    steps:

    - name: Enable GitHub debug logging
      run: |
        echo "ACTIONS_STEP_DEBUG=true" >> $GITHUB_ENV
        echo "GIT_TRACE=1" >> $GITHUB_ENV
        echo "GIT_CURL_VERBOSE=1" >> $GITHUB_ENV

    - name: Enable git debugging
      run: |
        git config --global advice.detachedHead false
        git config --global log.showSignature false
        git config --global fetch.showForcedUpdates true
        git config --global core.verbose true
        git config --global submodule.recurse true
        git config --global transfer.fsckobjects true
        git config --global trace true || true

    - name: Checkout repo with submodules (including PAT for submodule(s) with private repo)
      # uses: actions/checkout@v6
      #     This industry is shit
      # uses: actions/checkout@v4
      # uses: actions/checkout@v6
      # uses: actions/checkout@v5
      uses: actions/checkout@v6
      with:
         repository: "${{ github.repository }}"
         token: ${{ secrets.GH_PAT_FOR_SUBMODULES_PULL }}
         submodules: "recursive"
         persist-credentials: false
    
    - name: Force PAT for submodules
      run: |
        git config --global url."https://${{ secrets.GH_PAT_FOR_SUBMODULES_PULL }}:@github.com/".insteadOf "https://github.com/"

    - name: "Debug contents: List workspace content (pre-sm)"
      run: |
        echo "1=== check Submodules ==="
        git submodule status
        echo "2==="
        ls -R demos
        echo "3==="
        git submodule update --init --recursive
        echo "4==="
        ls -la
        echo "5==="
        ls -R demos
        echo "6==="
        ls -la ${{ github.workspace }}

#
# From: https://github.com/marketplace/actions/checkout-submodules
#    - name: Checkout submodules
#      uses: srt32/git-actions@v0.0.3
#      with:
#        args: git submodule update --init --recursive


    - name: Create Gemfile dynamically
      run: |
        echo "source 'https://rubygems.org'" > Gemfile
        echo "gem 'github-pages', group: :jekyll_plugins" >> Gemfile

    - name: Build the site in the jekyll/builder container
      run: |
        docker run \
          -v ${{ github.workspace }}:/srv/jekyll \
          -v ${{ github.workspace }}/_site:/srv/jekyll/_site \
          jekyll/builder:latest \
              /bin/bash -c "
                  set -e &&
                  set -x &&
                  cd /srv/jekyll &&
                  chmod -R 777 .  && echo 'write access is needed for gem install etc' &&
                  gem install bundler &&
                  bundle install --jobs 4 --retry 3 &&
                  cd /srv/jekyll &&
                  chmod 777 /srv/jekyll &&
                  jekyll build --trace --future --disable-disk-cache --verbose
                  # invalid option:
              "
        echo "This line is the next command after docker run (prev exit code was $1 )"   # back to "run" block
        ls -alth _site
        
    # ^ but this will go nowehere: has nowhere to go to. Hence, next step:

    - name: "Deploy to external repo via https://github.com/sohale/kill-build"
      if: ${{false}}
      run: |
        pwd
        # `_site/` is mounted from the GitHub runner → Docker wrote into it. The `_site` contains the full website
        cd _site
        pwd
        git config --global init.defaultBranch main  # note that it affects thw whole workflow(?) "globally"
        git init
        git checkout -b gh-pages
        git add .
        git config user.name "${{ github.actor }}"
        git config user.email "${{ github.actor }}@users.noreply.github.com"
        # May cause: nothing to commit (create/copy files and use "git add" to track)
        git commit -m "Deploy site"

        # oops NO!
        #git push --force \
        #  "https://${{ secrets.GH_PAT_FOR_SUBMODULES_PULL }}@github.com/sohale/kill-build.git" \
        #  gh-pages
    
    - name: Deploy to/via *kill-build* repo without force -f
      if: ${{false}}
      run: |
        # Clone the target repo
        git clone \
          "https://${{ secrets.GH_PAT_FOR_SUBMODULES_PULL }}@github.com/sohale/kill-build.git" \
          /tmp/kill-build
    
        cd /tmp/kill-build
    
        # Check out gh-pages (create if missing)
        if git rev-parse --verify gh-pages >/dev/null 2>&1; then
          git checkout gh-pages
        else
          git checkout --orphan gh-pages
          # git rm -rf .
        fi
    
        # Copy built files from _site into repo, overwriting duplicates
        cd /tmp/kill-build
        rsync -av --delete-before $GITHUB_WORKSPACE/_site/ ./
    
        # Commit changes only if modified
        git add .
        if ! git diff --cached --quiet; then
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git commit -m "Update built page/site from CI"
          git push origin gh-pages
        else
          echo "No changes to deploy."
        fi

    # indentation: step-level:
    # jobs: -> buildMaPage: -> steps:
    # steps:
  
    - name: Upload site artifact
      # Thank god: GitHub Pages Actions do not use branches anymore.
      # use artifacts and a hidden internal deployment pipeline.
      # “We give GitHub Pages the entire site as a zip file.”
      # it is a "temporary" (hidden: non-obsevable! In C++ sense)
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./_site

    - name: Inspect the "temporary" uploaded artifact
      run: |
        ls -R _site

  # next job (was: jobs: -> buildMaPage:)

  deploy-job:
    # deploys directly, and manually
    # only deploy after buildMaPage finished
    needs: buildMaPage
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

