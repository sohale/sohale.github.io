name: Jekyll site CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo with submodules (including PAT for submodule(s) with private repo)
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GH_PAT }}

#
# From: https://github.com/marketplace/actions/checkout-submodules
#    - name: Checkout submodules
#      uses: srt32/git-actions@v0.0.3
#      with:
#        args: git submodule update --init --recursive

    - name: List workspace content (pre-sm)
      run: ls -la ${{ github.workspace }}

    # Can be removed: manual git submodule updateâ€”unnecessary when using checkout correctly.
    - name: Checkout submodules (why not odone automatically? how was it working before, then?)
      run: git submodule update --init --recursive
  
    - name: List workspace content (post-sm)
      run: ls -la ${{ github.workspace }}

    - name: Build the site in the jekyll/builder container
      run: |
        docker run \
          -v ${{ github.workspace }}:/srv/jekyll \
          -v ${{ github.workspace }}/_site:/srv/jekyll/_site \
          jekyll/builder:latest \
              /bin/bash -c "
                  chmod 777 /srv/jekyll &&
                  jekyll build --trace --future --disable-disk-cache --verbose
              "

